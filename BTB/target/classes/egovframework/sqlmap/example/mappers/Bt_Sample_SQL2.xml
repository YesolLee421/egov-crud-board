<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="egovframework.example.sample.service.impl.BtMapper2">
	
	<resultMap id="btVO" type="egovframework.example.sample.service.BtVO">
		<result property="btId" column="bt_id"/>
		<result property="authorId" column="author_id"/>
		<result property="authorDepartment" column="author_department"/>
		<result property="approverId" column="approver_id"/>
		<result property="receiverId" column="receiver_id"/>
		<result property="travelerId" column="traveler_id"/>
		<result property="title" column="title"/>
		<result property="location" column="location"/>
		<result property="tripStartDate" column="trip_start_date"/>
		<result property="tripEndDate" column="trip_end_date"/>
		<result property="transportationType" column="transportation_type"/>
		<result property="tripPurpose" column="trip_purpose"/>
		<result property="fileDir" column="file_dir"/>
		<result property="approvalState" column="approval_state"/>
		<result property="createdAt" column="created_at"/>
		<collection property="btExpVOList" resultMap="BtExpVO" />
	</resultMap>
	
	<resultMap id="btAll" type="egovframework.example.sample.service.BtVO">
		<result property="btId" column="bt_id"/>
		<result property="authorId" column="author_id"/>
		<result property="authorDepartment" column="author_department"/>
		<result property="approverId" column="approver_id"/>
		<result property="receiverId" column="receiver_id"/>
		<result property="travelerId" column="traveler_id"/>
		<result property="title" column="title"/>
		<result property="location" column="location"/>
		<result property="tripStartDate" column="trip_start_date"/>
		<result property="tripEndDate" column="trip_end_date"/>
		<result property="transportationType" column="transportation_type"/>
		<result property="tripPurpose" column="trip_purpose"/>
		<result property="fileDir" column="file_dir"/>
		<result property="approvalState" column="approval_state"/>
		<result property="createdAt" column="created_at"/>
	</resultMap>
	
	<resultMap id="btRoleVO" type="egovframework.example.sample.service.BtRoleVO">
		<result property="btRoleId" column="bt_role_id"/>
		<result property="btId" column="bt_id"/>
		<result property="userId" column="user_id"/>
		<result property="userName" column="user_name"/>
		<result property="department" column="department"/>
		<result property="userPosition" column="user_position"/>
		<result property="userType" column="user_type"/>
	</resultMap>
	
	<resultMap id="btExpVO" type="egovframework.example.sample.service.BtExpVO">
		<result property="btExpId" column="bt_exp_id"/>
		<result property="btId" column="bt_id"/>
		<result property="expenseType" column="expense_type"/>
		<result property="expenseDetail" column="expense_detail"/>
		<result property="paymentMethod" column="payment_method"/>
		<result property="price" column="price"/>
	</resultMap>
	
	

	<insert id="insertBt" parameterType="btVO">
			INSERT INTO TBBUSINESSTRIP
				( BT_ID
				  , AUTHOR_ID
				  , AUTHOR_DEPARTMENT
				  , APPROVER_ID
				  , RECEIVER_ID
				  , TRAVELER_ID
				  , TITLE
				  , LOCATION
				  , TRIP_START_DATE
				  , TRIP_END_DATE
				  , TRANSPORTATION_TYPE
				  , TRIP_PURPOSE
				  , FILE_DIR
				  , APPROVAL_STATE
				  , CREATED_AT )
			VALUES ( #{btId}
				  , #{authorId}
				  , #{authorDepartment}
				  , #{approverId}
				  , #{receiverId}
				  , #{travelerId}
				  , #{title}
				  , #{location}
				  , #{tripStartDate}
				  , #{tripEndDate}
				  , #{transportationType}
				  , #{tripPurpose}
				  , #{fileDir}
				  , 0
				  , NOW())
	</insert>
	<insert id="insertBtRole" parameterType="btRoleVO">
			INSERT INTO TBBTROLE
				( BT_ID
				  , USER_ID
				  , USER_NAME
				  , DEPARTMENT
				  , USER_POSITION
				  , USER_TYPE )
			VALUES ( #{btId}
				  , #{userId}
				  , #{userName}
				  , #{department}
				  , #{userPosition}
				  , #{userType} )
	</insert>
	
	<insert id="insertBtExp" parameterType="btExpVO">
			INSERT INTO TBBTEXPENSES
				( BT_ID
				  , EXPENSE_TYPE
				  , EXPENSE_DETAIL
				  , PAYMENT_METHOD
				  , PRICE )
			VALUES ( #{btId}
				  , #{expenseType}
				  , #{expenseDetail}
				  , #{paymentMethod}
				  , #{price} )
	</insert>	
	
	
		

	<update id="updateBt">
			UPDATE TBBUSINESSTRIP
			SET 
				 AUTHOR_ID=#{authorId}
				, AUTHOR_DEPARTMENT=#{authorDepartment}
				, APPROVER_ID=#{approverId}
				, RECEIVER_ID=#{receiverId}
				, TRAVELER_ID=#{travelerId}
				, TITLE=#{title}
				, LOCATION=#{location}
				, TRIP_START_DATE=#{tripStartDate}
				, TRIP_END_DATE=#{tripEndDate}
				, TRANSPORTATION_TYPE=#{transportationType}
				, TRIP_PURPOSE=#{tripPurpose}
				, FILE_DIR=#{fileDir}
			WHERE BT_ID=#{btId}
	</update>
	<update id="updateBtRole">
			UPDATE TBBTROLE
			SET BT_ID=#{btId}
				, USER_ID=#{userId}
				, USER_NAME=#{userName}
				, DEPARTMENT=#{department}
				, USER_POSITION=#{userPosition}
				, USER_TYPE=#{userType}
			WHERE BT_ROLE_ID=#{btRoleId}
	</update>	
	<update id="updateBtExp">
			UPDATE TBBTEXPENSES
			SET 
				 EXPENSE_TYPE=#{expenseType}
				, EXPENSE_DETAIL=#{expenseDetail}
				, PAYMENT_METHOD=#{paymentMethod}
				, PRICE=#{price}
			WHERE BT_EXP_ID=#{btExpId}
	</update>

	<delete id="deleteBt">

			DELETE FROM TBBUSINESSTRIP
			WHERE BT_ID=#{btId}

	</delete>
	<delete id="deleteBtRole">

			DELETE FROM TBBTROLE
			WHERE BT_ROLE_ID=#{btRoleId}

	</delete>
	<delete id="deleteBtExp">

			DELETE FROM TBBTEXPENSES
			WHERE BT_EXP_ID=#{btExpId}

	</delete>

	<select id="selectBt" resultMap="btAll">

            SELECT
                BT_ID
				  , AUTHOR_ID
				  , AUTHOR_DEPARTMENT
				  , APPROVER_ID
				  , RECEIVER_ID
				  , TRAVELER_ID
				  , TITLE
				  , LOCATION
				  , TRIP_START_DATE
				  , TRIP_END_DATE
				  , TRANSPORTATION_TYPE
				  , TRIP_PURPOSE
				  , FILE_DIR
				  , APPROVAL_STATE
				  , CREATED_AT
            FROM TBBUSINESSTRIP
            WHERE BT_ID=#{btId}

	</select>


	<select id="selectBtList" parameterType="searchVO" resultType="egovMap">
	
			SELECT
				BT_ID, LOCATION, AUTHOR_ID, TRAVELER_ID, TRIP_START_DATE, TRIP_END_DATE
			FROM TBBUSINESSTRIP
			WHERE 1=1
			<if test="searchKeyword != null and searchKeyword != ''">
		        <choose>
		            <when test="searchCondition == 0">
						AND	TRAVELER_ID LIKE CONCAT('%', #{searchKeyword},'%')
					</when>
		            <when test="searchCondition == 1">
		            	
		            	<![CDATA[
						AND	TRIP_START_DATE <= CONCAT(#{searchKeyword}) AND TRIP_END_DATE >= CONCAT(#{searchKeyword})
						]]>
					</when>
				</choose>
			</if>
			ORDER BY CREATED_AT DESC
			LIMIT #{recordCountPerPage} OFFSET #{firstIndex}
	</select>
	
	<select id="selectBtRoleList" parameterType="String" resultType="egovMap">
			SELECT * FROM TBBTROLE
			WHERE BT_ID=#{btId}
	</select>
	
	<select id="selectBtExpList" parameterType="String" resultMap="btExpVO">
			SELECT BT_EXP_ID, BT_ID, EXPENSE_TYPE, EXPENSE_DETAIL, PAYMENT_METHOD, PRICE FROM TBBTEXPENSES
			WHERE BT_ID=#{btId}
	</select>


	<select id="selectBtListTotCnt" parameterType="searchVO" resultType="int">

			SELECT COUNT(*) totcnt
			FROM TBBUSINESSTRIP
			WHERE 1=1
			<if test="searchKeyword != null and searchKeyword != ''">
		        <choose>
		            <when test="searchCondition == 0">
						AND	TRAVELER_ID LIKE CONCAT('%', #{searchKeyword},'%')
					</when>
		            <when test="searchCondition == 1">
						<![CDATA[
						AND	TRIP_START_DATE <= CONCAT(#{searchKeyword}) AND TRIP_END_DATE >= CONCAT(#{searchKeyword})
						]]>
					</when>
				</choose>
			</if>
	</select>

</mapper>